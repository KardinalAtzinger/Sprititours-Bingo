<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bier-Bingo</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0b1220" />

  <style>
    :root{
      --bg:#0b1220; --txt:#fff; --muted:rgba(255,255,255,.72);
      --card:rgba(255,255,255,.06); --border:rgba(255,255,255,.12);
      --good:rgba(34,197,94,.20); --goodb:rgba(34,197,94,.55);
      --bad:rgba(239,68,68,.20); --badb:rgba(239,68,68,.55);
      --btn:rgba(255,255,255,.10); --btnb:rgba(255,255,255,.18);
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    body{margin:0;background:var(--bg);color:var(--txt)}
    header{padding:18px 18px 10px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    h1{margin:0;font-size:28px;font-weight:900}
    .sub{margin-top:6px;color:var(--muted);font-size:14px}
    .pill{border:1px solid var(--btnb);background:var(--btn);padding:10px 12px;border-radius:14px;color:#fff;cursor:pointer;font-weight:800}
    .wrap{padding:12px 18px 18px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .cell{border:1px solid var(--border);background:var(--card);border-radius:16px;padding:14px;min-height:120px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer}
    .cell.done{border-color:var(--goodb);background:var(--good)}
    .emoji{font-size:28px}
    .name{font-size:18px;font-weight:800}
    .hint{color:var(--muted);font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid var(--btnb);background:var(--btn);color:#fff;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn.danger{border-color:var(--badb);background:var(--bad)}
    .card{border:1px solid var(--border);background:var(--card);border-radius:16px;padding:14px}
    input,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:rgba(0,0,0,.22);color:#fff}
    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}
    hr{border:none;border-top:1px solid var(--border);margin:12px 0}

    dialog{border:none;border-radius:16px;padding:16px;max-width:360px;width:calc(100% - 24px)}
    dialog::backdrop{background:#0008}

    /* iOS Modal Ersatz */
    .bbOverlay{position:fixed;inset:0;background:#0008;display:flex;align-items:center;justify-content:center;z-index:9999}
    .bbModal{background:#0b1220;border:1px solid var(--border);border-radius:16px;width:min(420px,100%);max-height:85vh;display:flex;flex-direction:column}
    .bbModalHead{padding:16px 16px 0}
    .bbModalBody{padding:16px;overflow:auto}
    .bbModalFoot{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:10px}
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>

<header>
  <div>
    <h1>Bier-Bingo</h1>
    <div class="sub" id="status">â€”</div>
    <div class="sub" id="version">Version â€”</div>
  </div>
  <div class="row">
    <button class="pill" onclick="setView('board')">Board</button>
    <button class="pill" onclick="setView('confirm')">BestÃ¤tigen</button>
    <button class="pill" onclick="setView('leaderboard')">Rangliste</button>
    <button class="pill" onclick="setView('settings')">Setup</button>
  </div>
</header>

<div class="wrap" id="view"></div>

<!-- QR Dialog -->
<dialog id="dlgRequest">
  <h3>BestÃ¤tigung anfordern</h3>

  <div id="reqError" style="display:none;margin:10px 0;padding:10px;border-radius:12px;border:1px solid var(--badb);background:var(--bad)"></div>

  <div id="qr" style="margin:10px auto;width:max-content;background:#fff;padding:10px;border-radius:12px"></div>
  <div id="reqCode" style="word-break:break-all;font-family:monospace"></div>

  <hr />
  <div class="row">
    <button class="btn" id="reqGoSetup" style="display:none">Zu Setup</button>
    <button class="btn danger" onclick="dlgRequest.close()">SchlieÃŸen</button>
  </div>
</dialog>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://hyjydhxamcbeytlvzdnd.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_zASMa14T4TduXXR3MDaq6g_XrfmsFdx";
const TABLE = "bier_bingo_rooms";
const APP_VERSION = "1.0.3";

/* ================= STATE ================= */
const LOCAL_KEY="bier_bingo_pwa_v2";
const DEFAULT_FRIENDS=["Max","Ben","Lukas","Timo","Jonas","Paul","Moritz","Nico","Flo","Chris"];
const app={
  me:{playerId:crypto.randomUUID(),name:""},
  roomId:"",
  friends:DEFAULT_FRIENDS,
  pins:Array(10).fill("1234"),
  checkedLocal:{},
  cloud:{state:null},
  ui:{
    view:"board",
    confirmDraft:{friendIdx:0,visitorToken:"",pin:""}
  }
};

/* ================= HELPERS ================= */
const viewEl=document.getElementById("view");
const statusEl=document.getElementById("status");
const dlgRequest=document.getElementById("dlgRequest");

function escapeHtml(s){return String(s||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]))}

function setView(v){app.ui.view=v;render()}

/* ================= BOARD ================= */
function renderBoard(){
  statusEl.textContent="Board";
  const g=document.createElement("div");g.className="grid";
  app.friends.forEach((n,i)=>{
    const c=document.createElement("div");
    c.className="cell";
    c.innerHTML=`<div class="emoji">ðŸ”¥</div><div class="name">${escapeHtml(n)}</div><div class="hint">Grillen + Bier</div>`;
    c.onclick=()=>openRequestDialog(i);
    g.appendChild(c);
  });
  viewEl.innerHTML="";viewEl.appendChild(g);
}

/* ================= CONFIRM ================= */
function renderConfirm(){
  statusEl.textContent="BestÃ¤tigen";
  viewEl.innerHTML=`
    <div class="card">
      <label>Besucher-Code</label>
      <input id="visitorToken" value="${escapeHtml(app.ui.confirmDraft.visitorToken)}">

      <label>Welcher Kumpel bin ich?</label>
      <select id="friendIdx">
        ${app.friends.map((n,i)=>`<option value="${i}" ${i===app.ui.confirmDraft.friendIdx?"selected":""}>${escapeHtml(n)}</option>`).join("")}
      </select>

      <label>PIN</label>
      <input id="pin" value="${escapeHtml(app.ui.confirmDraft.pin)}">

      <button class="btn" style="margin-top:12px">BestÃ¤tigen</button>
    </div>
  `;
  visitorToken.oninput=()=>app.ui.confirmDraft.visitorToken=visitorToken.value;
  pin.oninput=()=>app.ui.confirmDraft.pin=pin.value;
  friendIdx.onchange=()=>app.ui.confirmDraft.friendIdx=Number(friendIdx.value);
}

/* ================= SETTINGS ================= */
function renderSettings(){
  statusEl.textContent="Setup";
  viewEl.innerHTML=`
    <div class="card">
      <label>Dein Name</label>
      <input id="meName">

      <label>Room-Code</label>
      <input id="roomId">

      <hr />
      ${app.friends.map((n,i)=>`
        <label>${escapeHtml(n)} â€“ PIN</label>
        <input id="pin_${i}" value="${escapeHtml(app.pins[i])}">
      `).join("")}
    </div>
  `;
  app.friends.forEach((_,i)=>{
    const el=document.getElementById("pin_"+i);
    el.oninput=()=>{app.pins[i]=el.value};
  });
}

/* ================= QR ================= */
function openRequestDialog(idx){
  const err=document.getElementById("reqError");
  const qr=document.getElementById("qr");
  const code=document.getElementById("reqCode");
  const go=document.getElementById("reqGoSetup");

  err.style.display="none";qr.innerHTML="";code.textContent="";go.style.display="none";

  if(!app.roomId||!app.me.name){
    err.style.display="block";
    err.innerHTML="Bitte Name & Room-Code im Setup setzen.";
    go.style.display="inline-block";
    go.onclick=()=>{dlgRequest.close();setView("settings")};
    dlgRequest.showModal();return;
  }

  const token=`${app.roomId}|${app.me.playerId}|${idx}|${Math.random().toString(16).slice(2,8)}`;
  new QRCode(qr,{text:token,width:220,height:220});

  code.textContent=token;
  dlgRequest.showModal();
}

/* ================= RENDER ================= */
function render(){
  if(app.ui.view==="board")renderBoard();
  else if(app.ui.view==="confirm")renderConfirm();
  else if(app.ui.view==="settings")renderSettings();
  else viewEl.innerHTML="";
}
render();
 const versionEl = document.getElementById("version");
if (versionEl) versionEl.textContent = "Version " + APP_VERSION;
</script>

</body>
</html>
