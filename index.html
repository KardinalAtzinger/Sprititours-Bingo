<!doctype html>
<html lang="de">
<head>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bier-Bingo</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0b1220" />

  <style>
    :root{
      --bg:#0b1220; --txt:#fff; --muted:rgba(255,255,255,.72);
      --card:rgba(255,255,255,.06); --border:rgba(255,255,255,.12);
      --good:rgba(34,197,94,.20); --goodb:rgba(34,197,94,.55);
      --bad:rgba(239,68,68,.20); --badb:rgba(239,68,68,.55);
      --btn:rgba(255,255,255,.10); --btnb:rgba(255,255,255,.18);
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    body{margin:0;background:var(--bg);color:var(--txt)}
    header{padding:18px 18px 10px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    h1{margin:0;font-size:28px;font-weight:900}
    .sub{margin-top:6px;color:var(--muted);font-size:14px}
    .pill{border:1px solid var(--btnb);background:var(--btn);padding:10px 12px;border-radius:14px;color:#fff;cursor:pointer;font-weight:800}
    .wrap{padding:12px 18px 18px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .cell{border:1px solid var(--border);background:var(--card);border-radius:16px;padding:14px;min-height:120px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer}
    .cell.done{border-color:var(--goodb);background:var(--good)}
    .emoji{font-size:28px}
    .name{font-size:18px;font-weight:800}
    .hint{color:var(--muted);font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid var(--btnb);background:var(--btn);color:#fff;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn.danger{border-color:var(--badb);background:var(--bad)}
    .card{border:1px solid var(--border);background:var(--card);border-radius:16px;padding:14px}
    input,select{
      width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);
      background:rgba(0,0,0,.22);color:#fff;
      outline:none;
    }
    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}
    hr{border:none;border-top:1px solid var(--border);margin:12px 0}

    dialog{border:none;border-radius:16px;padding:16px;max-width:360px;width:calc(100% - 24px)}
    dialog::backdrop{background:#0008}
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>

<header>
  <div>
    <h1>Bier-Bingo</h1>
    <div class="sub" id="status">‚Äî</div>
    <div class="sub" id="version">Version ‚Äî</div>
  </div>
  <div class="row">
    <button class="pill" onclick="setView('board')">Board</button>
    <button class="pill" onclick="setView('confirm')">Best√§tigen</button>
    <button class="pill" onclick="setView('leaderboard')">Rangliste</button>
    <button class="pill" onclick="setView('settings')">Setup</button>
    <button class="pill" onclick="setView('help')">Anleitung</button>
  </div>
</header>

<div class="wrap" id="view"></div>

<!-- QR Dialog (Host erzeugt QR f√ºr Best√§tigung) -->
<dialog id="dlgRequest">
  <h3>Best√§tigung anfordern</h3>

  <div id="reqError" style="display:none;margin:10px 0;padding:10px;border-radius:12px;border:1px solid var(--badb);background:var(--bad)"></div>

  <div id="qr" style="margin:10px auto;width:max-content;background:#fff;padding:10px;border-radius:12px"></div>
  <div id="reqCode" style="word-break:break-all;font-family:monospace"></div>

  <hr />
  <div class="row">
    <button class="btn" id="reqGoSetup" style="display:none">Zu Setup</button>
    <button class="btn danger" onclick="dlgRequest.close()">Schlie√üen</button>
  </div>
</dialog>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://hyjydhxamcbeytlvzdnd.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_zASMa14T4TduXXR3MDaq6g_XrfmsFdx";
const TABLE = "bier_bingo_rooms";
const APP_VERSION = "1.0.7";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= HARDCODED TEILNEHMER ================= */
const HARDCODED_FRIENDS = [
  "Rob","B√∂hmi","Chris","HoolGER","Tilo","Phil","Wim","Schachti","Janis","Franz"
];

/* ================= STATE ================= */
const LOCAL_KEY="bier_bingo_pwa_v2";

function uid() {
  return (crypto?.randomUUID?.() || ("u_" + Math.random().toString(16).slice(2) + Date.now().toString(16)));
}
function loadLocal(){
  try { return JSON.parse(localStorage.getItem(LOCAL_KEY) || "{}"); } catch { return {}; }
}
const local = loadLocal();

const app={
  me:{
    playerId: local.me?.playerId || uid(),
    name: local.me?.name || ""
  },
  roomId: local.roomId || "",
  friends: HARDCODED_FRIENDS.slice(),
  pins: Array.isArray(local.pins) && local.pins.length===10 ? local.pins : Array(10).fill("1234"),

  cloud:{
    room: null,
    confirmed: Array(10).fill(false),
    sub: null
  },

  ui:{
    view: local.ui?.view || "board",
    confirmDraft: local.ui?.confirmDraft || {friendIdx:0,visitorToken:"",pin:""},
    _scan: null // { stop() }
  }
};

function saveLocal(){
  localStorage.setItem(LOCAL_KEY, JSON.stringify({
    me: app.me,
    roomId: app.roomId,
    pins: app.pins,
    ui: { view: app.ui.view, confirmDraft: app.ui.confirmDraft }
  }));
}

/* ================= HELPERS ================= */
const viewEl=document.getElementById("view");
const statusEl=document.getElementById("status");
const dlgRequest=document.getElementById("dlgRequest");

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g,c=>(
    {"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]
  ));
}
function nowIso(){ return new Date().toISOString(); }

function stopScannerIfRunning(){
  if (app.ui._scan?.stop) {
    try { app.ui._scan.stop(); } catch {}
  }
  app.ui._scan = null;
}

function setView(v){
  // wenn View wechselt: Kamera/Scanner sauber stoppen
  if (app.ui.view !== v) stopScannerIfRunning();

  app.ui.view=v;
  saveLocal();
  render();
}

/* ================= SUPABASE HELPERS ================= */
function applyRoom(room){
  app.cloud.room = room || null;
  const st = room?.state || {};
  app.cloud.confirmed =
    Array.isArray(st.confirmed) && st.confirmed.length === 10
      ? st.confirmed.slice()
      : Array(10).fill(false);
}

async function fetchRoom(roomId){
  const { data, error } = await sb
    .from(TABLE)
    .select("*")
    .eq("room_id", roomId)
    .maybeSingle();
  if (error) throw error;
  return data || null;
}

function ensureRealtime(){
  if (!app.roomId) return;
  if (app.cloud.sub) return;

  app.cloud.sub = sb
    .channel("bier_bingo_room_changes_" + app.roomId)
    .on(
      "postgres_changes",
      { event: "*", schema: "public", table: TABLE, filter: `room_id=eq.${app.roomId}` },
      (payload) => {
        if (payload?.new) applyRoom(payload.new);
        render();
      }
    )
    .subscribe();
}

async function syncRoom(){
  if(!app.roomId) return;
  try{
    const room = await fetchRoom(app.roomId);
    if(room) applyRoom(room);
    ensureRealtime();
  }catch(e){
    console.warn("syncRoom failed:", e);
  }
}

/* ================= BOARD ================= */
function renderBoard(){
  statusEl.textContent = app.roomId ? `Board ‚Ä¢ Room: ${app.roomId}` : "Board ‚Ä¢ (kein Room)";

  const confirmed = app.cloud.confirmed || Array(10).fill(false);

  const g=document.createElement("div");g.className="grid";
  app.friends.forEach((n,i)=>{
    const c=document.createElement("div");
    c.className="cell" + (confirmed[i] ? " done" : "");
    c.innerHTML=`
      <div class="emoji">${confirmed[i] ? "‚úÖ" : "üî•"}</div>
      <div class="name">${escapeHtml(n)}</div>
      <div class="hint">${confirmed[i] ? "Best√§tigt" : "Grillen + Bier"}</div>
    `;
    c.onclick=()=>openRequestDialog(i);
    g.appendChild(c);
  });

  viewEl.innerHTML="";
  viewEl.appendChild(g);
}

/* ================= CONFIRM (mit Kamera-Scan + iOS-Fallback) ================= */
function renderConfirm(){
  statusEl.textContent = "Best√§tigen";

  // falls nochmal gerendert wird: alten Scan stoppen
  stopScannerIfRunning();

  viewEl.innerHTML = `
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <div style="font-weight:900;font-size:16px">QR-Scan</div>
        <div class="row">
          <button class="btn" id="scanStartBtn">Kamera starten</button>
          <button class="btn danger" id="scanStopBtn" style="display:none">Stop</button>
        </div>
      </div>

      <div class="sub" id="scanHint" style="margin-top:6px">
        Kamera starten ‚Üí QR ins Bild halten ‚Üí Code wird automatisch eingef√ºgt.
      </div>

      <div id="scanErr"
           style="display:none;margin:10px 0;padding:10px;border-radius:12px;border:1px solid var(--badb);background:var(--bad)"></div>

      <label style="margin-top:12px">Kamera ausw√§hlen</label>
      <select id="cameraSelect">
        <option value="">(Kamera wird geladen‚Ä¶)</option>
      </select>

      <div style="margin-top:10px;border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#000">
        <video id="scanVideo" playsinline muted style="width:100%;height:auto;display:block"></video>
      </div>

      <hr />

      <label>Besucher-Code</label>
      <input id="visitorToken" value="${escapeHtml(app.ui.confirmDraft.visitorToken)}" placeholder="room|playerId|idx|nonce">

      <label>Welcher Kumpel bin ich?</label>
      <select id="friendIdx">
        ${app.friends.map((n,i)=>`<option value="${i}" ${i===app.ui.confirmDraft.friendIdx?"selected":""}>${escapeHtml(n)}</option>`).join("")}
      </select>

      <label>PIN</label>
      <input id="pin" inputmode="numeric" autocomplete="one-time-code" value="${escapeHtml(app.ui.confirmDraft.pin)}" placeholder="z.B. 1234">

      <button class="btn" id="confirmBtn" style="margin-top:12px">Best√§tigen</button>
    </div>
  `;

  const tokenEl  = document.getElementById("visitorToken");
  const pinEl    = document.getElementById("pin");
  const friendEl = document.getElementById("friendIdx");
  const btnEl    = document.getElementById("confirmBtn");

  const scanErrEl     = document.getElementById("scanErr");
  const scanHintEl    = document.getElementById("scanHint");
  const scanStartBtn  = document.getElementById("scanStartBtn");
  const scanStopBtn   = document.getElementById("scanStopBtn");
  const cameraSelect  = document.getElementById("cameraSelect");
  const videoEl       = document.getElementById("scanVideo");

  function setScanError(msg){
    scanErrEl.style.display = msg ? "block" : "none";
    scanErrEl.textContent = msg || "";
  }

  tokenEl.addEventListener("input", () => { app.ui.confirmDraft.visitorToken = tokenEl.value; saveLocal(); });
  pinEl.addEventListener("input",   () => { app.ui.confirmDraft.pin = pinEl.value; saveLocal(); });
  friendEl.addEventListener("change",() => { app.ui.confirmDraft.friendIdx = Number(friendEl.value); saveLocal(); });

  async function listCameras(){
    if (!navigator.mediaDevices?.enumerateDevices) {
      cameraSelect.innerHTML = `<option value="">(nicht unterst√ºtzt)</option>`;
      return;
    }
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === "videoinput");

    if (!cams.length) {
      cameraSelect.innerHTML = `<option value="">(keine Kamera gefunden)</option>`;
      return;
    }

    cameraSelect.innerHTML = cams.map((c, idx) => {
      const label = c.label || `Kamera ${idx+1}`;
      // deviceId nicht escapen (ist kein HTML), aber label escapen:
      return `<option value="${c.deviceId}">${escapeHtml(label)}</option>`;
    }).join("");

    // versuch, R√ºckkamera vorzuw√§hlen
    const back = cams.find(c => /back|rear|r√ºck|environment/i.test(c.label));
    if (back) cameraSelect.value = back.deviceId;
  }

  function stopStream(stream){
    if (!stream) return;
    stream.getTracks().forEach(t => { try { t.stop(); } catch {} });
  }

  async function startScanner(deviceId){
    setScanError("");

    if (!window.isSecureContext) {
      setScanError("Kamera ben√∂tigt https (oder localhost).");
      return;
    }
    if (!navigator.mediaDevices?.getUserMedia) {
      setScanError("getUserMedia wird von diesem Browser nicht unterst√ºtzt.");
      return;
    }

    const constraints = deviceId
      ? { video: { deviceId: { exact: deviceId } }, audio: false }
      : { video: { facingMode: { ideal: "environment" } }, audio: false };

    let stream;
    try {
      stream = await navigator.mediaDevices.getUserMedia(constraints);
    } catch (e) {
      console.error(e);
      setScanError("Kamerazugriff verweigert oder nicht verf√ºgbar.");
      return;
    }

    videoEl.srcObject = stream;
    try { await videoEl.play(); } catch {}

    scanStartBtn.style.display = "none";
    scanStopBtn.style.display = "inline-block";

    let running = true;

    app.ui._scan = {
      stop: () => {
        running = false;
        stopStream(stream);
        videoEl.srcObject = null;
        scanStartBtn.style.display = "inline-block";
        scanStopBtn.style.display = "none";
      }
    };

    // A) BarcodeDetector (wenn vorhanden)
    const hasBarcodeDetector = ("BarcodeDetector" in window);
    const detector = hasBarcodeDetector ? new BarcodeDetector({ formats: ["qr_code"] }) : null;

    // B) jsQR Fallback (iOS Safari)
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d", { willReadFrequently: true });

    if (!hasBarcodeDetector) {
      scanHintEl.textContent = "iOS Safari: QR-Scan l√§uft √ºber Fallback (jsQR). QR kurz ruhig halten üôÇ";
      setScanError(""); // kein Fehler anzeigen
    }

    const tick = async () => {
      if (!running) return;

      try {
        if (videoEl.readyState >= 2) {
          // --- Versuch 1: BarcodeDetector ---
          if (detector) {
            const codes = await detector.detect(videoEl);
            if (codes && codes.length) {
              const value = (codes[0].rawValue || "").trim();
              if (value) {
                tokenEl.value = value;
                app.ui.confirmDraft.visitorToken = value;
                saveLocal();

                scanHintEl.textContent = "QR erkannt ‚úÖ Code wurde eingef√ºgt.";
                setScanError("");

                app.ui._scan.stop();
                app.ui._scan = null;
                return;
              }
            }
          } else {
            // --- Versuch 2: jsQR ---
            const w = videoEl.videoWidth;
            const h = videoEl.videoHeight;
            if (w && h) {
              // Performance-Boost f√ºr iPhone: kleiner auswerten
              const scale = 0.6;
              canvas.width = Math.floor(w * scale);
              canvas.height = Math.floor(h * scale);

              ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
              const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
              const qr = jsQR(img.data, img.width, img.height, { inversionAttempts: "dontInvert" });

              if (qr?.data) {
                const value = String(qr.data).trim();
                if (value) {
                  tokenEl.value = value;
                  app.ui.confirmDraft.visitorToken = value;
                  saveLocal();

                  scanHintEl.textContent = "QR erkannt ‚úÖ Code wurde eingef√ºgt.";
                  setScanError("");

                  app.ui._scan.stop();
                  app.ui._scan = null;
                  return;
                }
              }
            }
          }
        }
      } catch (e) {
        console.warn(e);
      }

      requestAnimationFrame(tick);
    };

    requestAnimationFrame(tick);

    // Nach Kamera-Permission sind Labels i.d.R. erst verf√ºgbar:
    // daher Kameraliste nach Start nochmal aktualisieren.
    try { await listCameras(); } catch {}
  }

  scanStartBtn.onclick = async () => {
    setScanError("");
    scanHintEl.textContent = "Kamera startet‚Ä¶";
    await startScanner(cameraSelect.value || "");
  };

  scanStopBtn.onclick = () => {
    stopScannerIfRunning();
    scanHintEl.textContent = "Scan gestoppt.";
  };

  cameraSelect.onchange = async () => {
    if (app.ui._scan?.stop) {
      stopScannerIfRunning();
      await startScanner(cameraSelect.value || "");
    }
  };

  // Kamera-Liste initial laden (Labels evtl. leer bis Permission)
  listCameras().catch(console.warn);

  // Best√§tigen (Supabase)
  btnEl.onclick = async () => {
    try {
      const raw = tokenEl.value.trim();
      const pin = pinEl.value.trim();
      const visitorIdx = Number(friendEl.value);

      if (!raw) return alert("Bitte Besucher-Code einf√ºgen.");
      if (!pin) return alert("Bitte PIN eingeben.");

      const parts = raw.split("|");
      if (parts.length !== 4) return alert("Ung√ºltiger Besucher-Code (room|playerId|idx|nonce).");

      const roomId = parts[0];
      const targetIdx = Number(parts[2]);
      const nonce = parts[3];

      if (!roomId) return alert("Token: room fehlt.");
      if (!Number.isFinite(targetIdx) || targetIdx < 0 || targetIdx > 9) return alert("Token: idx ung√ºltig.");
      if (!nonce) return alert("Token: nonce fehlt.");

      const { data: room, error } = await sb
        .from(TABLE)
        .select("*")
        .eq("room_id", roomId)
        .maybeSingle();

      if (error) throw error;
      if (!room || !room.state) return alert("Room nicht gefunden oder ohne State. Host: Setup ‚Üí Speichern.");

      const st = room.state || {};
      st.pins = Array.isArray(st.pins) ? st.pins : [];
      st.confirmed = Array.isArray(st.confirmed) && st.confirmed.length === 10 ? st.confirmed : Array(10).fill(false);
      st.confirmations = Array.isArray(st.confirmations) ? st.confirmations : [];

      if (String(st.pins?.[visitorIdx] ?? "").trim() !== String(pin).trim()) return alert("Falsche PIN.");
      if (st.confirmations.some(x => x && x.nonce === nonce)) return alert("Dieser Code wurde bereits verwendet.");

      if (st.confirmed[targetIdx]) {
        alert("Schon best√§tigt ‚úÖ");
        return setView("board");
      }

      st.confirmed[targetIdx] = true;
      st.confirmations.push({
        idx: targetIdx,
        byFriendIdx: visitorIdx,
        byName: app.friends[visitorIdx],
        nonce,
        at: nowIso()
      });
      st.updatedAt = nowIso();

      const { data: updated, error: updErr } = await sb
        .from(TABLE)
        .update({ state: st })
        .eq("room_id", roomId)
        .select("*")
        .single();

      if (updErr) throw updErr;

      applyRoom(updated);
      alert("Best√§tigung gespeichert ‚úÖ");
      setView("board");
    } catch (e) {
      console.error(e);
      alert("Fehler beim Best√§tigen: " + (e?.message || e));
    }
  };
}
/* ================= LEADERBOARD ================= */
function renderLeaderboard(){
  statusEl.textContent = "Rangliste";

  const room = app.cloud.room;
  const st = room?.state || {};

  const confirmed = Array.isArray(st.confirmed) && st.confirmed.length === 10
    ? st.confirmed
    : Array(10).fill(false);

  const confirmations = Array.isArray(st.confirmations) ? st.confirmations : [];

  const scoreByName = new Map();
  for (const c of confirmations) {
    const name = c?.byName || c?.by || "Unbekannt";
    scoreByName.set(name, (scoreByName.get(name) || 0) + 1);
  }
  for (const n of app.friends) {
    if (!scoreByName.has(n)) scoreByName.set(n, 0);
  }

  const rows = Array.from(scoreByName.entries())
    .map(([name, score]) => ({ name, score }))
    .sort((a,b) => (b.score - a.score) || a.name.localeCompare(b.name, "de"));

  const totalConfirmed = confirmed.filter(Boolean).length;

  viewEl.innerHTML = `
    <div class="card" style="margin-bottom:12px">
      <div style="font-weight:900;font-size:18px">Rangliste</div>
      <div class="sub" style="margin-top:6px">
        Room: ${escapeHtml(app.roomId || "‚Äî")} ‚Ä¢ Best√§tigt: ${totalConfirmed}/10
      </div>
    </div>

    <div class="card" style="margin-bottom:12px">
      <div style="font-weight:900;margin-bottom:8px">Punkte (Best√§tigungen vergeben)</div>
      ${rows.map((r, i) => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-top:1px solid var(--border)">
          <div style="display:flex;gap:10px;align-items:center">
            <div style="width:26px;text-align:center;font-weight:900;color:var(--muted)">${i+1}.</div>
            <div style="font-weight:800">${escapeHtml(r.name)}</div>
          </div>
          <div style="font-weight:900">${r.score}</div>
        </div>
      `).join("")}
    </div>

    <div class="card">
      <div style="font-weight:900;margin-bottom:8px">Status (wer ist schon best√§tigt?)</div>
      ${app.friends.map((name, idx) => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-top:1px solid var(--border)">
          <div style="font-weight:800">${escapeHtml(name)}</div>
          <div style="font-weight:900">${confirmed[idx] ? "‚úÖ" : "‚Äî"}</div>
        </div>
      `).join("")}
    </div>
  `;
}

/* ================= HELP / ANLEITUNG ================= */
function renderHelp(){
  statusEl.textContent = "Anleitung";

  viewEl.innerHTML = `
    <div class="card">
      <div style="font-weight:900;font-size:20px">üçª Bier-Bingo ‚Äì Anleitung</div>
      <div class="sub" style="margin-top:6px">
        Lesen dauert k√ºrzer als dein n√§chstes Bier.
      </div>

      <hr />

      <div style="font-weight:900">üî• Worum geht‚Äôs?</div>
      <p class="sub">
        Der Host grillt und trinkt Bier.  
        Du best√§tigst das Ganze ehrlich per QR-Code.
        Keine Accounts. Kein Login. Nur Wahrheit und Hopfen.
      </p>

      <hr />

      <div style="font-weight:900">üì∑ Schritt 1: Best√§tigen √∂ffnen</div>
      <p class="sub">
        √ñffne den Reiter <b>‚ÄûBest√§tigen‚Äú</b>.  
        Dort wartet schon der QR-Scanner auf dich.
      </p>

      <div style="font-weight:900">üì∏ Schritt 2: QR-Code scannen</div>
      <p class="sub">
        ‚Ä¢ Tippe auf <b>‚ÄûKamera starten‚Äú</b><br>
        ‚Ä¢ Halte dein Handy ruhig auf den QR-Code vom Host<br>
        ‚Ä¢ Wackeln erst nach dem Scan üç∫
      </p>

      <div style="font-weight:900">üßë‚Äçü§ù‚Äçüßë Schritt 3: Sag, wer du bist</div>
      <p class="sub">
        W√§hle <b>deinen Namen</b> aus der Liste.  
        Ehrlichkeit zahlt sich aus. Fr√ºher oder sp√§ter.
      </p>

      <div style="font-weight:900">üîê Schritt 4: PIN eingeben</div>
      <p class="sub">
        Gib deinen <b>PIN</b> ein.  
        Falscher PIN = kein H√§kchen = schlechtes Karma.
      </p>

      <div style="font-weight:900">‚úÖ Schritt 5: Best√§tigen</div>
      <p class="sub">
        Tippe auf <b>‚ÄûBest√§tigen‚Äú</b>.  
        Wenn alles passt: üéâ Erfolg!
      </p>

      <hr />

      <div style="font-weight:900">üèÜ Rangliste</div>
      <p class="sub">
        Zeigt live:
        ‚Ä¢ wer schon best√§tigt ist<br>
        ‚Ä¢ wer flei√üig scannt<br>
        ‚Ä¢ wer sich noch dr√ºckt üëÄ
      </p>

      <hr />

      <div style="font-weight:900">üç∫ Fazit</div>
      <p class="sub">
        Scannen. PIN. Best√§tigen.  
        Danach wieder zur√ºck zu den wichtigen Dingen im Leben.
      </p>
    </div>
  `;
}


/* ================= SETTINGS ================= */
function renderSettings(){
  statusEl.textContent = "Setup";

  viewEl.innerHTML = `
    <div class="card">
      <div style="font-weight:900;font-size:18px">Setup</div>
      <div class="sub" style="margin-top:6px">
        Host: Name + Room-Code setzen, dann Speichern (schreibt state.pins/confirmed in Supabase).
      </div>

      <label>Dein Name</label>
      <input id="meName" value="${escapeHtml(app.me.name)}" placeholder="z.B. Franz">

      <label>Room-Code</label>
      <input id="roomId" value="${escapeHtml(app.roomId)}" placeholder="z.B. sprititours2026">

      <div class="row" style="margin-top:12px">
        <button class="btn" id="saveSetup" style="background:rgba(34,197,94,.25);border-color:rgba(34,197,94,.6)">
          Speichern
        </button>
        <button class="btn danger" id="resetSetup">Reset lokal</button>
      </div>

      <hr />

      <div style="font-weight:900">Gastgeber-PINs</div>
      <div class="sub" style="margin-top:6px">
        Bleibt lokal auf deinem Ger√§t.
      </div>

      <div id="pins"></div>
    </div>
  `;

  const pinsWrap = document.getElementById("pins");
  const frag = document.createDocumentFragment();

  app.friends.forEach((name, i) => {
    const block = document.createElement("div");
    block.innerHTML = `
      <label>${escapeHtml(name)} ‚Äì PIN</label>
      <input id="pin_${i}" inputmode="numeric" autocomplete="one-time-code" value="${escapeHtml(app.pins[i])}">
    `;
    frag.appendChild(block);
  });

  pinsWrap.appendChild(frag);

  app.friends.forEach((_, i) => {
    const el = document.getElementById("pin_" + i);
    el.addEventListener("input", () => {
      const v = el.value;
      requestAnimationFrame(() => { app.pins[i] = v; });
    });
  });

  document.getElementById("saveSetup").onclick = async () => {
    const meName = document.getElementById("meName").value.trim();
    const roomId = document.getElementById("roomId").value.trim();

    if (!meName || !roomId) {
      alert("Bitte Name und Room-Code setzen.");
      return;
    }

    app.me.name = meName;
    app.roomId = roomId;

    for (let i = 0; i < 10; i++) {
      const p = (document.getElementById("pin_" + i)?.value || "").trim();
      app.pins[i] = p || "1234";
    }

    saveLocal();

    try {
      const { data: existing, error: selErr } = await sb
        .from(TABLE)
        .select("state")
        .eq("room_id", app.roomId)
        .maybeSingle();

      if (selErr) throw selErr;
      const prev = existing?.state || {};

      const nextState = {
        friends: app.friends.slice(),
        pins: app.pins.slice(),
        confirmed:
          Array.isArray(prev.confirmed) && prev.confirmed.length === 10
            ? prev.confirmed
            : Array(10).fill(false),
        confirmations: Array.isArray(prev.confirmations) ? prev.confirmations : [],
        updatedAt: nowIso()
      };

      const { data: upserted, error: upErr } = await sb
        .from(TABLE)
        .upsert({ room_id: app.roomId, state: nextState }, { onConflict: "room_id" })
        .select("*")
        .single();

      if (upErr) throw upErr;

      applyRoom(upserted);

      if (app.cloud.sub) {
        try { await sb.removeChannel(app.cloud.sub); } catch {}
        app.cloud.sub = null;
      }
      ensureRealtime();

      alert("Setup gespeichert ‚Äì Room ist jetzt aktiv ‚úÖ");
      render();
    } catch (e) {
      console.error(e);
      alert("Fehler beim Setup-Speichern: " + (e?.message || e));
      render();
    }
  };

  document.getElementById("resetSetup").onclick = () => {
    if (!confirm("Lokale Daten (Name, Room, PINs) zur√ºcksetzen?")) return;
    localStorage.removeItem(LOCAL_KEY);
    location.reload();
  };
}

/* ================= QR (Host erzeugt Token) ================= */
function openRequestDialog(idx){
  const err=document.getElementById("reqError");
  const qr=document.getElementById("qr");
  const code=document.getElementById("reqCode");
  const go=document.getElementById("reqGoSetup");

  err.style.display="none";qr.innerHTML="";code.textContent="";go.style.display="none";

  if(!app.roomId||!app.me.name){
    err.style.display="block";
    err.innerHTML="Bitte Name & Room-Code im Setup setzen.";
    go.style.display="inline-block";
    go.onclick=()=>{dlgRequest.close();setView("settings")};
    dlgRequest.showModal();
    return;
  }

  const token=`${app.roomId}|${app.me.playerId}|${idx}|${Math.random().toString(16).slice(2,8)}`;
  new QRCode(qr,{text:token,width:220,height:220});
  code.textContent=token;
  dlgRequest.showModal();
}

/* ================= RENDER ================= */
function render(){
  if(app.ui.view==="board") renderBoard();
  else if(app.ui.view==="confirm") renderConfirm();
  else if(app.ui.view==="leaderboard") renderLeaderboard();
  else if(app.ui.view==="settings") renderSettings();
  else if(app.ui.view==="help") renderHelp();
  else viewEl.innerHTML="";
}

render();

const versionEl = document.getElementById("version");
if (versionEl) versionEl.textContent = "Version " + APP_VERSION;

syncRoom();
</script>

</body>
</html>
